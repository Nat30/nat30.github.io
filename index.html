<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æœ¬åœ°ç¦»çº¿æ•°ç‹¬ - æ™ºèƒ½è¾…åŠ©ç‰ˆ</title>
    <style>
        :root {
            --bg-color: #f0f2f5;
            --board-bg: #ffffff;
            --line-color: #34495e;
            --light-line: #cbd5e0;
            --highlight-color: #e2e8f0;  /* æµ…ç°ï¼šè¡Œåˆ—èƒŒæ™¯ */
            --same-num-color: #bee3f8;   /* æµ…è“ï¼šç›¸åŒæ•°å­— */
            --selected-color: #63b3ed;   /* æ·±è“ï¼šå½“å‰é€‰ä¸­ */
            --text-color: #2d3748;
            --primary-color: #3182ce;
            --primary-active: #2c5282;
            --error-color: #e53e3e;
            --error-bg-color: #fed7d7;
            --fixed-num-color: #2d3748;
            --user-num-color: #2b6cb0;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: var(--bg-color);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            margin: 0;
            color: var(--text-color);
            touch-action: manipulation; 
        }

        h1 { margin-bottom: 10px; }

        .game-container {
            display: flex;
            gap: 20px;
            align-items: flex-start;
            margin-bottom: 20px;
        }

        .left-panel {
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        /* æ§åˆ¶æ  */
        .controls {
            margin-bottom: 20px;
            display: flex;
            gap: 10px;
            align-items: center;
        }

        select, button {
            padding: 8px 16px;
            border: 1px solid #cbd5e0;
            border-radius: 4px;
            background: white;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.1s;
            outline: none;
        }

        button:active {
            transform: scale(0.95);
            background-color: #e2e8f0;
        }

        button.primary {
            background-color: var(--primary-color);
            color: white;
            border: none;
        }
        button.primary:hover { background-color: #2b6cb0; }
        button.primary:active { 
            background-color: var(--primary-active); 
            transform: scale(0.95);
        }

        /* æ¸¸æˆé¢æ¿ */
        .game-board {
            display: grid;
            grid-template-columns: repeat(9, 50px);
            grid-template-rows: repeat(9, 50px);
            background-color: var(--line-color);
            gap: 1px;
            border: 2px solid var(--line-color);
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }

        .cell {
            background-color: var(--board-bg);
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 24px;
            cursor: pointer;
            user-select: none;
            position: relative;
            transition: background-color 0.1s;
        }

        .cell.border-bottom { border-bottom: 2px solid var(--line-color); }
        .cell.border-right { border-right: 2px solid var(--line-color); }

        /* --- çŠ¶æ€æ ·å¼ (æ³¨æ„é¡ºåºï¼šCSSåå®šä¹‰çš„ä¼˜å…ˆçº§é«˜ï¼Œå¦‚æœspecificityç›¸åŒ) --- */

        /* 1. åŸºç¡€é«˜äº® (è¡Œåˆ—è¾…åŠ©çº¿) */
        .cell.highlight { background-color: var(--highlight-color); }

        /* 2. ç›¸åŒæ•°å­— (æ¯”è¾…åŠ©çº¿æ›´é‡è¦) */
        .cell.same-number { background-color: var(--same-num-color); }

        /* 3. å½“å‰é€‰ä¸­ (æœ€é‡è¦) */
        .cell.selected { background-color: var(--selected-color); color: white; }
        
        /* å­—ä½“é¢œè‰² */
        .cell.fixed { font-weight: bold; color: var(--fixed-num-color); }
        .cell.user-input { color: var(--user-num-color); font-weight: 600; }
        
        /* é€‰ä¸­çŠ¶æ€ä¸‹çš„æ–‡å­—é¢œè‰²ä¿®æ­£ï¼Œä¿è¯å¯¹æ¯”åº¦ */
        .cell.selected.fixed, .cell.selected.user-input { color: white; }

        /* 4. é”™è¯¯æ ·å¼ (ç»å¯¹ä¼˜å…ˆçº§) */
        .cell.error { 
            background-color: var(--error-bg-color) !important; 
            color: var(--error-color) !important; 
        }
        
        /* çŠ¶æ€æ  */
        .status {
            margin-top: 20px;
            font-size: 16px;
            height: 24px;
            color: var(--primary-color);
            font-weight: bold;
            text-align: center;
        }

        /* æ•°å­—é”®ç›˜ */
        .numpad {
            display: grid;
            grid-template-columns: repeat(3, 60px);
            grid-template-rows: repeat(4, 60px);
            gap: 8px;
            padding: 10px;
            background-color: var(--board-bg);
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.08);
        }
        
        .num-btn {
            padding: 0;
            font-size: 24px;
            background: white;
            border: 1px solid #cbd5e0;
            border-radius: 8px;
            display: flex;
            justify-content: center;
            align-items: center;
            font-weight: bold;
            color: var(--text-color);
            box-shadow: 0 2px 0 #a0aec0;
            transition: all 0.05s ease-in-out;
        }

        .num-btn:active { 
            background-color: #e2e8f0;
            transform: translateY(2px);
            box-shadow: 0 0 0 #a0aec0;
        }
        
        .num-btn.clear, .num-btn.undo {
            background-color: #edf2f7;
            font-size: 16px;
            color: #4a5568;
        }
        
        .num-btn.clear { grid-column: span 2; }

        .num-btn.clear:active, .num-btn.undo:active {
            background-color: #cbd5e0;
            color: #2d3748;
            transform: translateY(2px);
            box-shadow: 0 0 0 #a0aec0;
        }

        @media (max-width: 768px) {
            .game-container {
                flex-direction: column;
                align-items: center;
            }
            .game-board {
                grid-template-columns: repeat(9, 9vw);
                grid-template-rows: repeat(9, 9vw);
                max-width: 81vw;
            }
            .cell { font-size: 16px; }
            .numpad {
                margin-top: 20px;
                grid-template-columns: repeat(5, 1fr);
                grid-template-rows: 50px 50px;
                width: 90%;
                gap: 8px;
            }
            .num-btn { font-size: 20px; }
            .num-btn.clear { grid-column: span 2; }
            .num-btn.undo { grid-column: span 1; }
        }
    </style>
</head>
<body>

    <h1>æ•°ç‹¬ (Sudoku)</h1>

    <div class="controls">
        <select id="difficulty">
            <option value="30">ç®€å•</option>
            <option value="40">ä¸­ç­‰</option>
            <option value="50">å›°éš¾</option>
            <option value="60">ä¸“å®¶</option>
        </select>
        <button class="primary" onclick="newGame()">æ–°æ¸¸æˆ</button>
    </div>

    <div class="game-container">
        <div class="left-panel">
            <div id="board" class="game-board"></div>
        </div>
        
        <div class="right-panel">
            <div class="numpad">
                <button class="num-btn" onclick="fillNumber(1)">1</button>
                <button class="num-btn" onclick="fillNumber(2)">2</button>
                <button class="num-btn" onclick="fillNumber(3)">3</button>
                <button class="num-btn" onclick="fillNumber(4)">4</button>
                <button class="num-btn" onclick="fillNumber(5)">5</button>
                <button class="num-btn" onclick="fillNumber(6)">6</button>
                <button class="num-btn" onclick="fillNumber(7)">7</button>
                <button class="num-btn" onclick="fillNumber(8)">8</button>
                <button class="num-btn" onclick="fillNumber(9)">9</button>
                <button class="num-btn clear" onclick="fillNumber(0)">æ¸…é™¤</button>
                <button class="num-btn undo" onclick="undoLastMove()">æ’¤é”€</button>
            </div>
        </div>
    </div>

    <div class="status" id="status-msg"></div>

    <script>
        let boardArray = [];
        let solutionArray = [];
        let fixedCells = [];
        let selectedIndex = -1;
        let history = [];
        const MAX_HISTORY = 50;

        document.addEventListener('DOMContentLoaded', () => {
            createBoardDOM();
            newGame();
            document.addEventListener('keydown', handleKeyPress);
        });

        function createBoardDOM() {
            const boardDiv = document.getElementById('board');
            boardDiv.innerHTML = '';
            for (let i = 0; i < 81; i++) {
                let cell = document.createElement('div');
                cell.classList.add('cell');
                cell.dataset.index = i;
                
                const row = Math.floor(i / 9);
                const col = i % 9;
                if (col === 2 || col === 5) cell.classList.add('border-right');
                if (row === 2 || row === 5) cell.classList.add('border-bottom');

                cell.addEventListener('click', () => selectCell(i));
                boardDiv.appendChild(cell);
            }
        }

        function newGame() {
            const difficulty = parseInt(document.getElementById('difficulty').value);
            
            clearStatus();
            selectedIndex = -1;
            boardArray = new Array(81).fill(0);
            solutionArray = new Array(81).fill(0);
            fixedCells = [];
            history = [];

            fillDiagonal();
            solve(solutionArray);

            boardArray = [...solutionArray];
            removeDigits(difficulty);

            renderBoard();
        }

        function fillDiagonal() {
            for (let i = 0; i < 9; i = i + 3) fillBox(i, i);
        }

        function fillBox(row, col) {
            let num;
            for (let i = 0; i < 3; i++) {
                for (let j = 0; j < 3; j++) {
                    do {
                        num = Math.floor(Math.random() * 9) + 1;
                    } while (!isSafeBox(row, col, num));
                    solutionArray[(row + i) * 9 + (col + j)] = num;
                }
            }
        }

        function isSafeBox(rowStart, colStart, num) {
            for (let i = 0; i < 3; i++) {
                for (let j = 0; j < 3; j++) {
                    if (solutionArray[(rowStart + i) * 9 + (colStart + j)] === num) return false;
                }
            }
            return true;
        }

        function isSafe(board, row, col, num) {
            for (let x = 0; x < 9; x++) if (board[row * 9 + x] === num) return false;
            for (let x = 0; x < 9; x++) if (board[x * 9 + col] === num) return false;
            let startRow = row - row % 3, startCol = col - col % 3;
            for (let i = 0; i < 3; i++)
                for (let j = 0; j < 3; j++)
                    if (board[(startRow + i) * 9 + (startCol + j)] === num) return false;
            return true;
        }

        function solve(board) {
            for (let i = 0; i < 81; i++) {
                if (board[i] === 0) {
                    for (let num = 1; num <= 9; num++) {
                        const row = Math.floor(i / 9);
                        const col = i % 9;
                        if (isSafe(board, row, col, num)) {
                            board[i] = num;
                            if (solve(board)) return true;
                            board[i] = 0;
                        }
                    }
                    return false;
                }
            }
            return true;
        }

        function removeDigits(count) {
            let attempts = count;
            let cellIndices = Array.from({length: 81}, (_, i) => i);
            shuffleArray(cellIndices);

            for (let i = 0; i < cellIndices.length && attempts > 0; i++) {
                let idx = cellIndices[i];
                if (boardArray[idx] !== 0) {
                    boardArray[idx] = 0;
                    attempts--;
                }
            }
            for (let i = 0; i < 81; i++) {
                if (boardArray[i] !== 0) fixedCells.push(i);
            }
        }

        function shuffleArray(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
        }

        function renderBoard() {
            const cells = document.querySelectorAll('.cell');
            cells.forEach((cell, i) => {
                // é‡ç½®æ‰€æœ‰çŠ¶æ€ç±»
                cell.className = 'cell'; 
                
                // æ¢å¤è¾¹æ¡†ç±»
                const row = Math.floor(i / 9);
                const col = i % 9;
                if (col === 2 || col === 5) cell.classList.add('border-right');
                if (row === 2 || row === 5) cell.classList.add('border-bottom');

                if (boardArray[i] !== 0) {
                    cell.textContent = boardArray[i];
                    if (fixedCells.includes(i)) {
                        cell.classList.add('fixed');
                    } else {
                        cell.classList.add('user-input');
                        if (boardArray[i] !== solutionArray[i]) {
                            cell.classList.add('error');
                        }
                    }
                } else {
                    cell.textContent = '';
                }
            });
            // æ¸²æŸ“å†…å®¹åå†åº”ç”¨é«˜äº®é€»è¾‘
            highlightCells();
        }

        function selectCell(index) {
            selectedIndex = index;
            renderBoard();
        }

        function highlightCells() {
            const cells = document.querySelectorAll('.cell');
            
            // å…ˆæ¸…é™¤æ‰€æœ‰ä¹‹å‰çš„é«˜äº®
            // æ³¨æ„ï¼šæˆ‘ä»¬ä¸æ¸…é™¤ 'fixed', 'user-input', 'error', 'border-*' ç­‰åŸºç¡€æ ·å¼
            // åªæ¸…é™¤äº¤äº’ç›¸å…³çš„çŠ¶æ€ç±»
            cells.forEach(c => c.classList.remove('selected', 'highlight', 'same-number'));

            if (selectedIndex === -1) return;

            const selectedVal = boardArray[selectedIndex];
            const currentRow = Math.floor(selectedIndex / 9);
            const currentCol = selectedIndex % 9;

            // 1. è®¡ç®—æ‰€æœ‰éœ€è¦é«˜äº®çš„è¡Œå’Œåˆ—
            let rowsToHighlight = new Set([currentRow]);
            let colsToHighlight = new Set([currentCol]);

            // å¦‚æœé€‰ä¸­äº†æ•°å­—ï¼ˆéç©ºï¼‰ï¼Œæ‰¾åˆ°ç›˜é¢ä¸Šæ‰€æœ‰ç›¸åŒçš„æ•°å­—ï¼ŒæŠŠå®ƒä»¬çš„è¡Œåˆ—ä¹ŸåŠ å…¥é«˜äº®é›†åˆ
            if (selectedVal !== 0) {
                boardArray.forEach((num, index) => {
                    if (num === selectedVal) {
                        rowsToHighlight.add(Math.floor(index / 9));
                        colsToHighlight.add(index % 9);
                    }
                });
            }

            // 2. éå†åº”ç”¨æ ·å¼
            cells.forEach((c, i) => {
                const r = Math.floor(i / 9);
                const cIdx = i % 9;

                // è§„åˆ™1ï¼šå¤„äºéœ€è¦é«˜äº®çš„è¡Œæˆ–åˆ—
                if (rowsToHighlight.has(r) || colsToHighlight.has(cIdx)) {
                    c.classList.add('highlight');
                }

                // è§„åˆ™2ï¼šç›¸åŒçš„æ•°å­—ï¼ˆæ’é™¤ç©ºï¼‰
                if (selectedVal !== 0 && boardArray[i] === selectedVal) {
                    c.classList.add('same-number');
                }

                // è§„åˆ™3ï¼šå½“å‰é€‰ä¸­çš„æ ¼å­ (æœ€ååº”ç”¨ï¼ŒCSSä¸­ä¼˜å…ˆçº§æœ€é«˜)
                if (i === selectedIndex) {
                    c.classList.add('selected');
                }
            });
        }

        function handleKeyPress(e) {
            if (selectedIndex === -1) return;
            const row = Math.floor(selectedIndex / 9);
            const col = selectedIndex % 9;
            
            if (e.key === 'ArrowUp') { selectCell(row > 0 ? selectedIndex - 9 : selectedIndex); e.preventDefault(); }
            else if (e.key === 'ArrowDown') { selectCell(row < 8 ? selectedIndex + 9 : selectedIndex); e.preventDefault(); }
            else if (e.key === 'ArrowLeft') { selectCell(col > 0 ? selectedIndex - 1 : selectedIndex); e.preventDefault(); }
            else if (e.key === 'ArrowRight') { selectCell(col < 8 ? selectedIndex + 1 : selectedIndex); e.preventDefault(); }
            else if (e.key >= '1' && e.key <= '9') { fillNumber(parseInt(e.key)); }
            else if (e.key === 'Backspace' || e.key === 'Delete') { fillNumber(0); }
        }

        function fillNumber(num) {
            if (selectedIndex === -1) {
                updateStatus("è¯·å…ˆé€‰æ‹©ä¸€ä¸ªæ ¼å­ï¼");
                return;
            }
            if (fixedCells.includes(selectedIndex)) {
                updateStatus("ä¸èƒ½ä¿®æ”¹é¢˜ç›®é¢„è®¾çš„æ•°å­—ï¼");
                return;
            }

            const oldValue = boardArray[selectedIndex];
            if (oldValue === num) return;

            history.push({ index: selectedIndex, oldValue: oldValue, newValue: num });
            if (history.length > MAX_HISTORY) history.shift();

            boardArray[selectedIndex] = num;
            renderBoard();
            
            if (num !== 0 && num !== solutionArray[selectedIndex]) {
                 updateStatus("æ•°å­—ä¸æ­£ç¡®ï¼", true);
            } else if (num !== 0) {
                 document.getElementById('status-msg').textContent = "";
            }
            
            if (!boardArray.includes(0) && checkWin()) {
                updateStatus("ğŸ‰ æ­å–œä½ ï¼Œè§£é¢˜æˆåŠŸï¼");
            }
        }

        function undoLastMove() {
            if (history.length === 0) {
                updateStatus("æ²¡æœ‰å¯ä»¥æ’¤é”€çš„æ“ä½œäº†ï¼");
                return;
            }
            const lastMove = history.pop();
            const { index, oldValue } = lastMove;

            boardArray[index] = oldValue;
            selectedIndex = index;
            
            renderBoard();
            updateStatus("å·²æ’¤é”€ä¸Šä¸€æ­¥æ“ä½œã€‚");
        }

        function checkWin() {
            for (let i = 0; i < 81; i++) {
                if (boardArray[i] !== solutionArray[i]) return false;
            }
            return true;
        }

        function updateStatus(msg, isError = false) {
            const el = document.getElementById('status-msg');
            el.textContent = msg;
            el.style.color = isError ? 'var(--error-color)' : 'var(--primary-color)';
            if (!isError && msg.includes("æ­å–œ")) {} else {
                setTimeout(() => { el.textContent = ''; }, 2000);
            }
        }

        function clearStatus() {
            document.getElementById('status-msg').textContent = '';
        }
    </script>
</body>
</html>